<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S.O.S. Rotas - Login</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-page="login">
  <main class="view" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;display: flex;justify-content: center;align-items: center;">
    <form id="loginForm" class="card" style="width: 400px;">
      <h2>Autenticação</h2>
      <label>Usuário
        <input type="text" id="loginUsername" autocomplete="username" />
      </label>
      <label>Senha
        <input type="password" id="loginPassword" autocomplete="current-password" />
      </label>
      <button type="submit" style="margin-top: 16px;">Entrar</button>
      <div id="loginError" class="error" role="alert"></div>
    </form>
    <div id="toast" class="toast" hidden></div>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_URL = 'http://localhost:8080/api/usuarios/login'
      const loginForm = document.getElementById('loginForm')
      const loginError = document.getElementById('loginError')
      const usernameInput = document.getElementById('loginUsername')
      const passwordInput = document.getElementById('loginPassword')

      if(!loginForm) return

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault()
        if(loginError) loginError.textContent = ''

        const username = usernameInput?.value || ''
        const password = passwordInput?.value || ''
        if(!username || !password){
          if(loginError) loginError.textContent = 'Preencha usuário e senha.'
          return
        }
        console.log('Tentando logar com', username, password)
        try{
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ login: username, senha: password }),
          })
          if(!response.ok){
            throw new Error('Credenciais inválidas')
          }
          const data = await response.json()

          localStorage.setItem('authToken', data.token)
          localStorage.setItem('userLogin', data.login ?? username)
          localStorage.setItem('userPerfilNome', data.perfilNome ?? '')

          // TODO: redirecionar conforme perfil
          /*
          if(data.perfilNome === 'Admin'){
            window.location.href = 'dashboard_admin.html'
          }else if(data.perfilNome === 'Operador'){
            window.location.href = 'dashboard.html'
          } else {
            window.location.href = 'error.html'
          }
          */
          window.location.href = 'dashboard.html'
        }catch(error){
          const message = error instanceof Error ? error.message : 'Erro ao tentar fazer login.'
          if(loginError) loginError.textContent = message
        }
      })
    })
  </script>
</body>
</html>
